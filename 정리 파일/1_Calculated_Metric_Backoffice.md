# Calculated Metric Backoffice 설정 페이지 명세서

## 1. 페이지 개요

### 목적
기존 Airbridge 메트릭을 사칙연산(+, -, *, /)으로 조합하여 커스텀 계산 메트릭(Calculated Metric)을 생성, 조회, 수정, 삭제하는 관리 도구입니다.

### 주요 기능
1. **메트릭 생성**: Organization ID, Key, Display Name, Expression(JSON 수식)을 입력하여 새로운 Calculated Metric 생성
2. **메트릭 조회/검색**: Organization별 등록된 메트릭 목록 조회 및 검색 (Key, Display Name 필터링)
3. **메트릭 수정**: 기존 메트릭의 Display Name, Expression 수정 (Key는 변경 불가)
4. **메트릭 삭제**: 등록된 메트릭 삭제 (되돌릴 수 없음)
5. **템플릿 적용**: CPI, CPP, CTR 등 자주 사용하는 수식을 템플릿으로 제공하여 클릭 한 번에 적용
6. **수식 검증 및 미리보기**: JSON 형식 검증 및 사람이 읽을 수 있는 수식으로 변환하여 미리보기

### 타겟 사용자
- Airbridge 내부 운영팀
- 고객 성공 매니저 (CSM)
- 백엔드 개발자

### 접근 권한

| 항목 | 규칙 |
|------|------|
| 접근 경로 | 백오피스 내부 페이지 (HomeNav 드롭다운으로 진입) |
| 인증 | 백오피스 공통 인증 (별도 페이지 레벨 권한 없음) |
| 권한 범위 | 인증된 사용자는 모든 Organization의 메트릭에 대해 CRUD 가능 |
| 감사 로그 | 현재 미구현 (향후 생성/수정/삭제 이력 추적 필요) |

---

## 2. 정책 사항

### 입력 제한 및 유효성 검사

#### Organization ID
| 항목 | 규칙 |
|------|------|
| 필수 여부 | 필수 |
| 형식 | 숫자 |
| 검증 시점 | 제출 시 (생성하기/조회 버튼 클릭) |
| 예시 | `1872465354` |

#### Key
| 항목 | 규칙 |
|------|------|
| 필수 여부 | 필수 |
| 허용 문자 | 영어 소문자 + 언더스코어(_)만 |
| 정규식 | `/^[a-z_]+$/` |
| 검증 시점 | 입력 즉시 (onChange) — 형식 위반 시 인라인 에러 |
| 중복 검사 | 조직 내 중복 불가 (제출 시 서버 검증) |
| 수정 가능 여부 | **생성 후 변경 불가** |
| 예시 | `cost_per_install`, `cpm_app` |

#### Display Name
| 항목 | 규칙 |
|------|------|
| 필수 여부 | 필수 |
| 검증 시점 | 제출 시 |
| 중복 검사 | 조직 내 중복 불가 |
| 용도 | 리포트 메트릭 드롭다운에 표시 |
| 예시 | `Cost Per Purchase - CPP (App)` |

#### Expression (수식)
| 항목 | 규칙 |
|------|------|
| 필수 여부 | 필수 |
| 형식 | JSON |
| 검증 트리거 | Ctrl+Enter 또는 포커스 해제 (onBlur) |
| 지원 타입 | `arithmetic`, `constant`, `fieldAccess` |
| 미리보기 갱신 | 검증 성공 시 자동 |

### 비즈니스 로직 규칙

#### Expression Schema 정의
수식은 3가지 타입을 중첩하여 구성합니다:

**1. arithmetic (계산식)**
```json
{
  "type": "arithmetic",
  "fn": "+", // +, -, *, / 중 하나
  "fields": [...] // 피연산자 목록 (중첩 가능)
}
```

**2. constant (상수)**
```json
{
  "type": "constant",
  "value": 1000 // 정수 또는 소수 (음수 허용)
}
```

**3. fieldAccess (메트릭 참조)**
```json
{
  "type": "fieldAccess",
  "metric": "cost_channel" // 사용할 metric key
}
```

**Expression 예시 (CPI = Cost / Install)**
```json
{
  "fn": "/",
  "type": "arithmetic",
  "fields": [
    {"type": "fieldAccess", "metric": "cost_channel"},
    {"type": "fieldAccess", "metric": "app_installs"}
  ]
}
```

### 에러 처리 정책

| 에러 상황 | 메시지 | 처리 방식 | 발생 시점 |
|-----------|--------|-----------|-----------|
| Organization ID 미입력 | "Organization ID를 입력해주세요." | Toast 에러 | 제출 시 |
| Key 형식 오류 | "Only lowercase letters and underscores (_) are allowed" | 인라인 에러 | 입력 즉시 |
| Key 미입력/오류 | "유효한 Key를 입력해주세요." | Toast 에러 | 제출 시 |
| Key 중복 | "이미 존재하는 Key입니다." | Toast 에러 | API 응답 시 |
| Display Name 미입력 | "Display Name을 입력해주세요." | Toast 에러 | 제출 시 |
| Display Name 중복 | "이미 존재하는 Display Name입니다." | Toast 에러 | API 응답 시 |
| Expression 미입력/오류 | "유효한 Expression을 입력해주세요." | Toast 에러 | 제출 시 |
| JSON 파싱 실패 | "Invalid JSON format. Check braces, commas, and quotes." | 인라인 에러 | 검증 트리거 시 |
| type 필드 누락 | 'Missing "type" field' | 인라인 에러 | 검증 트리거 시 |
| 잘못된 type 값 | "Invalid type. Must be arithmetic, constant, or fieldAccess" | 인라인 에러 | 검증 트리거 시 |
| API 네트워크 에러 | "서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요." | Toast 에러 | API 호출 실패 시 |
| API 서버 에러 (5xx) | "서버 오류가 발생했습니다. 관리자에게 문의해주세요." | Toast 에러 | API 응답 시 |

### 주의사항
- 고객사 적용 전 반드시 **ablog (Org ID: 1872465354)**에서 먼저 테스트
- 수식 내에서 다른 Calculated Metric 참조 불가
- 삭제 시 Saved Report에서 자동 제거됨 (동일 Key로 재생성 시 복구 가능)
- 0.005 미만의 값은 리포트에서 0으로 표시됨
- Key 변경이 필요한 경우 삭제 후 재생성

---

## 3. 화면 구조 (ASCII Wireframe)

### 전체 레이아웃

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ [🏠 Select: Page Navigation      ▼]                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Calculated Metric 설정                                                     │
│  기존 Airbridge 메트릭을 사칙연산으로 조합하여 새로운 메트릭을 만드는 도구  │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ℹ️ 사용 가이드                                      [접기 ▲] [펼치기 ▼]│   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ ▶ Calculated Metric이란?                                            │   │
│  │ ▶ 사용 방법                                                         │   │
│  │ ▶ Schema 정의 방법                                                  │   │
│  │ ▶ 주의사항                                                          │   │
│  │ ▶ 참고 사항                                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ ┌──────────────┬────────────────┐                                   │   │
│  │ │   생성      │   조회/수정    │  ◄── 탭 네비게이션                 │   │
│  │ └──────────────┴────────────────┘                                   │   │
│  │                                                                     │   │
│  │  [탭 콘텐츠 영역 - 아래 상세 참조]                                  │   │
│  │                                                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**레이아웃 제약**
- 콘텐츠 최대 너비: `920px`, 중앙 정렬
- 좌우 패딩: `24px` (모바일 `16px`)
- 탭 카드 내부 패딩: `24px`

### 생성 탭 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Organization ID                                                            │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ 숫자로 입력 (예: 1872465354)                                          │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  테스트: [ablog (1872465354) 자동 입력] ◄── 클릭 가능한 텍스트 링크        │
│                                                                             │
│  Key                                                                        │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ 영어 소문자와 _ 만 (예: cost_per_install)                             │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  예: `cost_per_install`                                                     │
│  (에러 시) ⚠ Only lowercase letters and underscores (_) are allowed        │
│                                                                             │
│  Display Name                                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ 예: Cost Per Purchase - CPP (App)                                     │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  리포트 메트릭 드롭다운에 표시됩니다.                                       │
│                                                                             │
│  Expression (수식)                                                          │
│  JSON 형식 계산 수식. 직접 작성하거나 템플릿에서 적용하세요.                │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────┐        │
│  │ [📋 수식 템플릿 열기 ▼]  ✓ "CPI" 적용됨 ◄── 선택 시 배지 표시  │        │
│  └────────────────────────────────────────────────────────────────┘        │
│  ┌────────────────────────────────────────────────────────────────┐        │
│  │ (템플릿 목록 - 펼침 시)                                         │        │
│  │ ┌──────────────────────────────────────────────────────────┐   │        │
│  │ │ 🔍 템플릿 검색...                                        │   │        │
│  │ └──────────────────────────────────────────────────────────┘   │        │
│  │ ┌──────────────────────────────────────────────────────────┐   │        │
│  │ │ CPI          Cost / Install                    적용 →   │   │        │
│  │ │ CPP (App)    Cost / Order Complete             적용 →   │   │        │
│  │ │ CTR          (Click / Impressions) × 100       적용 →   │   │        │
│  │ │ CPM (App)    (Cost / Ad Imp) × 1000            적용 →   │   │        │
│  │ │ ...                                                      │   │        │
│  │ └──────────────────────────────────────────────────────────┘   │        │
│  └────────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ {"fn":"/","type":"arithmetic","fields":[...]}                         │ │
│  │                                                                       │ │
│  │ (여러 줄 텍스트 영역)                                                 │ │
│  │                                                                       │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│  (검증 전) Ctrl+Enter 또는 포커스 해제 시 JSON 검증                         │
│  (검증 성공) ✓ 유효한 JSON 형식입니다                                       │
│  (검증 실패) ⚠ Invalid JSON format...                                       │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────┐        │
│  │ 📐 수식 미리보기                                                │        │
│  │ cost_channel / app_installs                                     │        │
│  └────────────────────────────────────────────────────────────────┘        │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │                            생성하기                                   │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐ │
│  │ ⚠ 생성 전 확인                                                        │ │
│  │   • 반드시 ablog에서 먼저 테스트                                      │ │
│  │   • Key, Display Name 조직 내 중복 불가                               │ │
│  │   • 생성 후 Actuals 리포트에서 수식 확인                              │ │
│  └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 조회/수정 탭 상세

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│  Organization ID                                                            │
│  ┌───────────────────────────────────────────────────┐ ┌─────────┐         │
│  │ 1872465354                                         │ │  조회   │         │
│  └───────────────────────────────────────────────────┘ └─────────┘         │
│                                                                             │
│  ┌────────────┐                                                             │
│  │ 6개 메트릭 │  ◄── 검색 결과 카운트 배지                                 │
│  └────────────┘                                                             │
│                                                                             │
│  ┌────────────────────────────────────────────────────┐ ┌────────────┐     │
│  │ 🔍 검색...                                         │ │ 전체   ▼  │     │
│  └────────────────────────────────────────────────────┘ └────────────┘     │
│                                                          (Key/Display)     │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │     │ Key          │ Display Name                     │ Created    │   │
│  ├─────┼──────────────┼──────────────────────────────────┼────────────┤   │
│  │ ○   │ cpp_app      │ Cost Per Purchase - CPP (App)    │ 2022-08-15 │   │
│  │ ●   │ cpi          │ Cost Per Install                 │ 2022-09-01 │ ◄─ 선택됨
│  │ ○   │ cpm_app      │ CPM (App)                        │ 2023-03-10 │   │
│  │ ○   │ ecpm_app     │ eCPM (App)                       │ 2023-03-10 │   │
│  │ ○   │ profit_pct   │ Profit %                         │ 2023-05-20 │   │
│  │ ○   │ profit_loss  │ Profit/Loss (Revenue - Cost)     │ 2023-05-20 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  (메트릭 미선택 시) 테이블에서 메트릭을 클릭하여 수정/삭제                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 메트릭 수정                              ID: 1789             [✕]  │   │
│  ├─────────────────────────────────────────────────────────────────────┤   │
│  │ ┌───────────────────────────────────┐  ┌─────────────────────────┐ │   │
│  │ │                                   │  │ 📐 수식 미리보기        │ │   │
│  │ │ Key (변경 불가)                   │  │                         │ │   │
│  │ │ ┌────────────────────────────┐   │  │ cost_channel /          │ │   │
│  │ │ │ cpi                       │   │  │ app_installs            │ │   │
│  │ │ └────────────────────────────┘   │  │                         │ │   │
│  │ │                                   │  ├─────────────────────────┤ │   │
│  │ │ Display Name                      │  │ 파싱된 JSON             │ │   │
│  │ │ ┌────────────────────────────┐   │  │ {                       │ │   │
│  │ │ │ Cost Per Install          │   │  │   "fn": "/",            │ │   │
│  │ │ └────────────────────────────┘   │  │   "type": "arithmetic", │ │   │
│  │ │                                   │  │   "fields": [...]       │ │   │
│  │ │ Expression                        │  │ }                       │ │   │
│  │ │ ┌────────────────────────────┐   │  │                         │ │   │
│  │ │ │ {"fn":"/","type":...      │   │  │                         │ │   │
│  │ │ │ ...                        │   │  │                         │ │   │
│  │ │ └────────────────────────────┘   │  └─────────────────────────┘ │   │
│  │ │                                   │                              │   │
│  │ │ ┌────────────────┐ ┌────────────┐│                              │   │
│  │ │ │     수정       │ │    삭제    ││                              │   │
│  │ │ └────────────────┘ └────────────┘│                              │   │
│  │ └───────────────────────────────────┘                              │   │
│  │                                                                     │   │
│  │ ┌─────────────────────────────────────────────────────────────┐   │   │
│  │ │ ⚠ Key 변경 필요 시 삭제 후 재생성하세요.                    │   │   │
│  │ │   동일 Key로 재생성하면 Saved Report 사용 가능합니다.       │   │   │
│  │ └─────────────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 삭제 확인 모달

```
┌─────────────────────────────────────────────────────────────────┐
│                                                                 │
│  메트릭 삭제                                                    │
│                                                                 │
│  Cost Per Install                                               │
│  key: cpi                                                       │
│                                                                 │
│  ┌───────────────────────────────────────────────────────────┐ │
│  │ ⚠ 삭제하면 되돌릴 수 없습니다.                            │ │
│  │   Saved Report에서 자동 제거됩니다.                       │ │
│  └───────────────────────────────────────────────────────────┘ │
│                                                                 │
│                          ┌────────────┐  ┌────────────┐        │
│                          │   취소     │  │   삭제     │        │
│                          └────────────┘  └────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 상태별 화면 변화

#### 로딩 상태
- 조회 버튼 클릭 시: "조회" 버튼 비활성화 + 스피너 표시
- 생성하기 버튼 클릭 시: 버튼 비활성화 + 스피너 표시
- 수정/삭제 버튼 클릭 시: 버튼 비활성화 + 스피너 표시
- 테이블 로딩 중: 스켈레톤 로딩 표시 (행 3개 placeholder)

#### 에러 상태
- Key 입력 에러: 입력 필드 테두리 빨간색, 아래에 에러 메시지 표시
- Expression 에러: 텍스트 영역 테두리 빨간색, 아래에 에러 메시지 표시
- Toast 에러: 화면 우하단에 에러 토스트 표시 (5초 후 자동 사라짐)

#### 빈 상태
- 조회 전: 테이블 비노출, 안내 텍스트 없음
- 조회 결과 0건: "등록된 메트릭이 없습니다" 텍스트 표시
- 검색 결과 없음: "검색 결과 없음" 텍스트 표시
- 메트릭 미선택: "테이블에서 메트릭을 클릭하여 수정/삭제" 안내 텍스트

#### 성공 상태
- Expression 검증 성공: 입력 필드 테두리 녹색, "✓ 유효한 JSON 형식입니다" 표시
- 생성 성공: Toast 성공 + 폼 초기화
- 수정 성공: Toast 성공 + 테이블 목록 갱신
- 삭제 성공: Toast 성공 + 테이블에서 제거 + 수정 패널 닫힘

---

## 4. 인터랙션 상세

### 버튼별 동작 정의

| 버튼/액션 | 위치 | 트리거 | 동작 | 완료 후 |
|-----------|------|--------|------|---------|
| ablog 자동 입력 | 생성 탭 Org ID 하단 | 클릭 | Org ID 필드에 `1872465354` 채움 | — |
| 수식 템플릿 열기 | 생성 탭 Expression 상단 | 클릭 | Collapsible 토글 (열기/닫기) | — |
| 템플릿 적용 | 템플릿 목록 각 행 | 클릭 | Expression 필드에 JSON 채움 + 자동 검증 + 미리보기 갱신 + 배지 표시 | Collapsible 닫힘 |
| 생성하기 | 생성 탭 하단 | 클릭 | 폼 유효성 → API 호출 → Toast | 성공 시 폼 초기화 |
| 조회 | 조회 탭 Org ID 우측 | 클릭 또는 Enter | API 호출 → 테이블 렌더링 | 이전 선택 초기화 |
| 테이블 행 | 조회 탭 테이블 | 클릭 | 라디오 선택 + 수정 패널 노출 (기존 값 채움) | — |
| 수정 패널 닫기 [✕] | 수정 패널 우상단 | 클릭 | 수정 패널 닫힘 + 선택 해제 | — |
| 수정 | 수정 패널 하단 | 클릭 | 폼 유효성 → API 호출 → Toast | 성공 시 테이블 갱신 |
| 삭제 | 수정 패널 하단 | 클릭 | 삭제 확인 모달 열기 | — |
| 모달 - 취소 | 삭제 모달 | 클릭 | 모달 닫힘 | — |
| 모달 - 삭제 | 삭제 모달 | 클릭 | API 호출 → Toast | 성공 시 모달 닫힘 + 테이블 갱신 + 패널 닫힘 |

### 인터랙션 타이밍

| 인터랙션 | 방식 | 값 |
|----------|------|-----|
| 검색 필터링 | 입력 즉시 (클라이언트 필터) | 디바운스 없음 — 로컬 데이터 필터링 |
| Key 형식 검증 | 입력 즉시 (onChange) | 디바운스 없음 — 정규식 매칭 |
| Expression 검증 | Ctrl+Enter 또는 onBlur | 즉시 실행 (JSON.parse + schema 검증) |
| Toast 자동 닫힘 | 표시 후 | 5초 |
| 버튼 로딩 상태 | API 호출 중 | 호출 시작~응답까지 비활성화 |
| 가이드 아코디언 | 클릭 토글 | 애니메이션 200ms (Collapsible 기본) |
| 템플릿 Collapsible | 클릭 토글 | 애니메이션 200ms |
| 삭제 모달 | 열기/닫기 | Dialog 기본 애니메이션 |
| 탭 전환 | 클릭 | 즉시 전환 (데이터 유지 — 탭 간 상태 독립) |

### 키보드 접근성

| 키 | 동작 |
|----|------|
| Tab | 폼 필드 간 포커스 이동 |
| Enter | Org ID 입력 후 → 조회 실행 (조회 탭), 생성 폼에서는 동작 없음 (textarea 줄바꿈 우선) |
| Ctrl+Enter | Expression 텍스트 영역에서 JSON 검증 트리거 |
| Escape | 삭제 모달 닫기 |

---

## 5. 컴포넌트 상세

### 계층 구조

```
App
├── HomeNav                    // 페이지 네비게이션 드롭다운
├── PageHeader                 // 페이지 제목 및 설명
├── Separator
├── GuideAccordion             // 사용 가이드 아코디언
│   └── TypeCard               // Schema 타입 설명 카드
└── Card (Tabs)
    ├── TabsList
    │   ├── TabsTrigger (생성)
    │   └── TabsTrigger (조회/수정)
    └── CardContent
        ├── TabsContent (create)
        │   └── CreateTab
        │       ├── Input (Organization ID)
        │       ├── Input (Key)
        │       ├── Input (Display Name)
        │       ├── TemplateList
        │       │   ├── CollapsibleTrigger
        │       │   └── CollapsibleContent (템플릿 목록)
        │       ├── Textarea (Expression)
        │       ├── ExpressionPreview
        │       ├── Button (생성하기)
        │       └── Alert (주의사항)
        └── TabsContent (list)
            └── ListTab
                ├── Input (Organization ID) + Button (조회)
                ├── Badge (메트릭 개수)
                ├── Input (검색) + Select (필터)
                ├── Table (메트릭 목록)
                │   └── TableRow (선택 가능)
                ├── Edit Panel (선택 시 표시)
                │   ├── Input (Key - disabled)
                │   ├── Input (Display Name)
                │   ├── Textarea (Expression)
                │   ├── ExpressionPreview
                │   ├── Button (수정)
                │   └── Button (삭제)
                └── Dialog (삭제 확인)
```

### 각 컴포넌트별 Props 및 역할

#### CreateTab
| 항목 | 내용 |
|------|------|
| 역할 | 새 메트릭 생성 폼 |
| State | orgId, key, displayName, expression, selectedTemplate, keyError, exprValidation |
| 성공 시 | 모든 State 초기화 (orgId 유지) |

#### ListTab
| 항목 | 내용 |
|------|------|
| 역할 | 메트릭 조회/수정/삭제 |
| State | orgId, metrics[], search, filterField, selectedMetric, deleteModalOpen, editDisplayName, editExpression, exprValidation, isLoading |
| 조회 시 | metrics[] 갱신 + selectedMetric 초기화 |

#### TemplateList
| 항목 | 내용 |
|------|------|
| 역할 | 수식 템플릿 선택 UI |
| Props | onSelect: (template: Template) => void, selectedTemplate?: string |
| 내부 State | isOpen, searchQuery |

#### ExpressionPreview
| 항목 | 내용 |
|------|------|
| 역할 | 파싱된 수식 미리보기 |
| Props | formula: string, className?: string |
| 렌더링 조건 | formula가 빈 문자열이 아닐 때만 표시 |

#### GuideAccordion
| 항목 | 내용 |
|------|------|
| 역할 | 사용 가이드 아코디언 |
| State | isOpen (기본값: false — 접힌 상태) |

---

## 6. 사용자 플로우

### 시나리오 1: 새 메트릭 생성

```
[생성 탭 클릭] → Org ID 입력 → Key 입력 → Display Name 입력
                                   │
                    ┌──────────────┴──────────────┐
                    ▼                              ▼
            [템플릿 사용]                    [직접 입력]
            템플릿 열기 →                   Expression에
            검색 → 클릭                     JSON 직접 작성 →
                    │                       Ctrl+Enter로 검증
                    ▼                              │
            Expression 자동 채움                    ▼
            + 자동 검증                     검증 성공/실패
                    │                              │
                    └──────────────┬──────────────┘
                                   ▼
                          수식 미리보기 확인
                                   ▼
                          [생성하기] 클릭
                                   ▼
                    ┌──────────────┴──────────────┐
                    ▼                              ▼
              [성공 Toast]                   [에러 Toast]
              폼 초기화                      메시지 확인 후 수정
```

1. "생성" 탭 클릭
2. Organization ID 입력 (또는 테스트 링크 클릭으로 자동 입력)
3. Key 입력 (영어 소문자 + 언더스코어만)
4. Display Name 입력
5. **방법 A - 템플릿 사용:**
   - "수식 템플릿 열기" 클릭
   - 원하는 템플릿 검색 또는 스크롤
   - 템플릿 클릭하여 적용 → Expression 자동 채움 + 검증 + 미리보기
6. **방법 B - 직접 입력:**
   - Expression 텍스트 영역에 JSON 직접 입력
   - Ctrl+Enter 또는 포커스 해제로 검증
7. 수식 미리보기 확인
8. "생성하기" 버튼 클릭
9. 성공 토스트 확인 → 폼 초기화 (orgId는 유지)

### 시나리오 2: 기존 메트릭 수정

1. "조회/수정" 탭 클릭
2. Organization ID 입력 후 "조회" 클릭 (또는 Enter)
3. 검색어 입력하여 메트릭 필터링 (선택 사항)
4. 테이블에서 수정할 메트릭 행 클릭 → 수정 패널 노출
5. 수정 패널에서 Display Name 또는 Expression 수정
6. "수정" 버튼 클릭
7. 성공 토스트 확인 → 테이블 자동 갱신

### 시나리오 3: 메트릭 삭제

1. "조회/수정" 탭에서 삭제할 메트릭 선택
2. "삭제" 버튼 클릭 → 확인 모달 열림
3. 모달에서 메트릭 이름/Key 확인
4. "삭제" 클릭
5. 성공 토스트 확인
6. 테이블에서 메트릭 제거 + 수정 패널 닫힘

---

## 7. API 명세

### 데이터 모델

#### CalculatedMetric
```typescript
interface CalculatedMetric {
  id: number;           // 메트릭 고유 ID (서버 생성)
  key: string;          // 메트릭 키 (예: "cpp_app")
  displayName: string;  // 표시 이름 (예: "Cost Per Purchase - CPP (App)")
  expression: string;   // JSON 수식 문자열
  createdAt: string;    // 생성일 (예: "2022-08-15")
}
```

#### Template (클라이언트 상수)
```typescript
interface Template {
  name: string;      // 템플릿 이름 (예: "CPI")
  formula: string;   // 사람이 읽을 수 있는 수식 (예: "Cost / Install")
  expression: string; // JSON 수식 문자열
}
```

### API 엔드포인트

#### 메트릭 목록 조회

```
GET /api/orgs/{orgId}/calculated-metrics
```

| 항목 | 내용 |
|------|------|
| Path Param | orgId: number (Organization ID) |
| Query Param | 없음 (필터링은 클라이언트에서 수행) |
| 호출 시점 | 조회 탭에서 "조회" 버튼 클릭 시 |

**Response 200**
```json
{
  "data": [
    {
      "id": 1789,
      "key": "cpi",
      "displayName": "Cost Per Install",
      "expression": "{\"fn\":\"/\",\"type\":\"arithmetic\",\"fields\":[{\"type\":\"fieldAccess\",\"metric\":\"cost_channel\"},{\"type\":\"fieldAccess\",\"metric\":\"app_installs\"}]}",
      "createdAt": "2022-09-01"
    }
  ]
}
```

**Response 404** — 존재하지 않는 Organization
```json
{
  "error": {
    "code": "ORG_NOT_FOUND",
    "message": "Organization not found"
  }
}
```

---

#### 메트릭 생성

```
POST /api/orgs/{orgId}/calculated-metrics
```

| 항목 | 내용 |
|------|------|
| Path Param | orgId: number |
| 호출 시점 | 생성 탭에서 "생성하기" 버튼 클릭 시 |

**Request Body**
```json
{
  "key": "cost_per_install",
  "displayName": "Cost Per Install",
  "expression": "{\"fn\":\"/\",\"type\":\"arithmetic\",\"fields\":[...]}"
}
```

**Response 201** — 생성 성공
```json
{
  "data": {
    "id": 1790,
    "key": "cost_per_install",
    "displayName": "Cost Per Install",
    "expression": "...",
    "createdAt": "2026-02-09"
  }
}
```

**Response 400** — 유효성 에러
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid expression format",
    "details": [
      { "field": "expression", "message": "Missing \"type\" field" }
    ]
  }
}
```

**Response 409** — Key 또는 Display Name 중복
```json
{
  "error": {
    "code": "DUPLICATE_KEY",
    "message": "Key 'cost_per_install' already exists in this organization"
  }
}
```

---

#### 메트릭 수정

```
PUT /api/orgs/{orgId}/calculated-metrics/{id}
```

| 항목 | 내용 |
|------|------|
| Path Param | orgId: number, id: number (메트릭 ID) |
| 호출 시점 | 수정 패널에서 "수정" 버튼 클릭 시 |
| 제약 | Key는 수정 불가 — Request Body에 포함하지 않음 |

**Request Body**
```json
{
  "displayName": "Cost Per Install (Updated)",
  "expression": "{\"fn\":\"/\",\"type\":\"arithmetic\",\"fields\":[...]}"
}
```

**Response 200** — 수정 성공
```json
{
  "data": {
    "id": 1789,
    "key": "cpi",
    "displayName": "Cost Per Install (Updated)",
    "expression": "...",
    "createdAt": "2022-09-01"
  }
}
```

**Response 404** — 메트릭 없음
```json
{
  "error": {
    "code": "METRIC_NOT_FOUND",
    "message": "Calculated metric not found"
  }
}
```

**Response 409** — Display Name 중복
```json
{
  "error": {
    "code": "DUPLICATE_DISPLAY_NAME",
    "message": "Display name already exists in this organization"
  }
}
```

---

#### 메트릭 삭제

```
DELETE /api/orgs/{orgId}/calculated-metrics/{id}
```

| 항목 | 내용 |
|------|------|
| Path Param | orgId: number, id: number |
| 호출 시점 | 삭제 확인 모달에서 "삭제" 버튼 클릭 시 |

**Response 204** — 삭제 성공 (빈 응답)

**Response 404** — 메트릭 없음
```json
{
  "error": {
    "code": "METRIC_NOT_FOUND",
    "message": "Calculated metric not found"
  }
}
```

---

### API 에러 공통 처리

| HTTP 상태 | 클라이언트 처리 |
|-----------|----------------|
| 400 | 에러 메시지 Toast 표시. details 배열이 있으면 첫 번째 항목 메시지 사용 |
| 404 (Org) | "존재하지 않는 Organization입니다." Toast 표시 |
| 404 (Metric) | "메트릭을 찾을 수 없습니다." Toast 표시 |
| 409 | 서버 메시지 그대로 Toast 표시 |
| 500 | "서버 오류가 발생했습니다. 관리자에게 문의해주세요." Toast 표시 |
| Network Error | "서버 연결에 실패했습니다. 잠시 후 다시 시도해주세요." Toast 표시 |

### 현재 Mock vs 실제 API 전환

| 기능 | 현재 구현 (Mock) | 실제 API 전환 시 변경 사항 |
|------|-----------------|--------------------------|
| 목록 조회 | mockMetrics 배열 반환 | API 호출 + 로딩/에러 상태 처리 |
| 생성 | Toast만 표시 | API 호출 + 응답 검증 + 폼 초기화 |
| 수정 | Toast만 표시 | API 호출 + 목록 갱신 |
| 삭제 | 로컬 상태에서만 제거 | API 호출 + 목록 갱신 |
| Key 중복 검사 | 미구현 | 생성 API 409 응답으로 처리 |
| Expression 검증 | 클라이언트 JSON 파싱만 | 클라이언트 검증 유지 + 서버 2차 검증 |

---

## 8. 디자인/개발 체크리스트

### 디자이너 체크리스트

- [ ] 탭 UI 스타일 (선택/미선택 상태)
- [ ] 템플릿 목록 hover/selected 상태
- [ ] Expression 검증 상태별 테두리 색상 (녹색: 성공, 빨간색: 실패)
- [ ] 수식 미리보기 박스 스타일 (녹색 배경)
- [ ] 테이블 행 선택 상태 (배경색, 라디오 버튼)
- [ ] 에러 메시지 스타일
- [ ] Toast 알림 스타일 (성공/에러)
- [ ] 삭제 확인 모달 destructive 스타일
- [ ] 가이드 아코디언 펼침/접힘 상태
- [ ] 반응형 레이아웃 (최대 너비 920px)
- [ ] 버튼 로딩(스피너) 상태

### 개발자 체크리스트

- [ ] Organization ID 실제 API 연동
- [ ] Key 중복 검사 API 연동
- [ ] 메트릭 CRUD API 연동
- [ ] Expression 서버 사이드 유효성 검사 연동
- [ ] metric key 자동 완성 (Service Spec 연동)
- [ ] 페이지네이션 (메트릭 목록이 많을 경우)
- [ ] 에러 바운더리 처리
- [ ] 로딩 상태 UI 추가
- [ ] 키보드 접근성 (Tab 네비게이션, Enter 제출)
- [ ] 폼 유효성 검사 강화 (dirty 상태 추적)
- [ ] API 에러 응답별 Toast 메시지 매핑
- [ ] 네트워크 에러/타임아웃 처리
